<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="">
    <title>Noctis Alba Â· Invite Friends</title>

    <link rel="canonical" href="">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
<link href="bootstrap.min.css" rel="stylesheet">
	      <!-- Custom styles for this template -->
    <link href="signin.css" rel="stylesheet">
	  	  <!-- Custom CSS -->
<link href="custom.css" rel="stylesheet">

  </head>
  <body id="invite-friends" class="text-center">

	  <!-- Modal -->
<div class="modal fade" id="sampleInviteModal" tabindex="-1" role="dialog" aria-labelledby="SampleInviteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Sample Invite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
		  <div class="text-left" style="color:#ffffff; background-color:#A904A1; padding: 5px 10px;">NOCTIS ALBA</div><!-- title -->
		  <div style="border: 1px solid #A904A1; padding-top: 10px;"><!-- begin sample wrap -->
		  <div class="col-12">

      <p class="text-left font-weight-bold">FRIENDS NAME join my new community on Noctis Alba, where they are helping make our insomnia an opportunity, not a problem! </p>
		  <p class="text-left">Noctis Alba, is a website that makes it easy to tell people you are awake without sending them an alert and possibly waking them. Still allowing for the opportunity of connecting and having more meaningful hours in your day, no matter what time it is.</p> 
		  <p class="text-left">Stop wasting your nights and connect with one another.</p>
		  <p class="text-left"><button type="button" class="btn btn-success">Accept Your Invitation</button></p>

		  </div>
		</div><!-- end sample wrap -->
      </div><!-- end modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close Sample Invite</button>
     
      </div>
    </div>
  </div>
</div>
	<!-- End Modal -->
	  <a class="" href="index.html"><img class="logo" src="images/NA-Logo.svg" alt="Noctis Alba Logo"></a>
	  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
	
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarCollapse">
    <ul class="navbar-nav mr-auto">
           <li class="nav-item">
        <a class="nav-link" href="features.html"><i class="fa fa-star"></i> Features <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="about-us.html"><i class="fa fa-address-card"></i> About us</a>
      </li>
		<li class="nav-item">
        <a class="nav-link" href="help.html"><i class="fa fa-question-circle"></i> Help</a>
      </li>
		 <li class="nav-item">
        <a class="nav-link" href="friends.html"><i class="fa fa-address-book"></i> Friends</a>
      </li>
		 <li class="nav-item active">
        <a class="nav-link" href="invite-friends.html"><i class="fa fa-envelope"></i> Invite</a>
      </li>

      <!--<li class="nav-item">
        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
      </li>

    <form class="form-inline mt-2 mt-md-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>-->
</ul>
<ul class="navbar-nav ml-auto">
				  <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="dropdown03" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="images/avatar-icon.png" height="21" width="21" style="margin-right:5px"> Julie Cops</a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdown03">
          <a class="dropdown-item" href="settings.html#collapseSettings"><i class="fa fa-gear"></i> Settings</a>
          <a class="dropdown-item" href="index.html"><i class="fa fa-sign-out"></i> Logout</a>
        </div>
      </li>
</ul>
  </div>
</nav>

<div class="hidden-sm-down shape-diamond-bg"><div id="shape-diamond"></div></div>
	
<form class="form-signin" onsubmit="sendInvite(event)" method="post">
<h1 class="mb-3 font-weight-normal">Invite Your Friends</h1>
<p><a id="font18" href="#" class="text-white" data-toggle="modal" data-target="#sampleInviteModal">View sample invite</a><br />
	<!-- trigger for modal -->
</p>
<div class="form-group">
<label for="inputEmail" class="sr-only">Email address</label>
  <input type="email" required id="inputEmail" name="inputEmail" class="form-control" placeholder="Email address"  aria-label="email address" autofocus>
		</div>
		<div class="form-group">
    <label for="inputName" class="sr-only">First Name</label>
    <input type="text" required id="inputName" name="inputName" class="form-control" aria-label="first name" placeholder="First Name" >
    </div>
    
    <input type="hidden" id="senderName" name="senderName" value="">

    <input type="hidden" id="inviteCode" name="inviteCode" value="">


		</div>
  <button id="sbmt" class="btn btn-lg btn-primary btn-block" type="submit">Confirm Invite</button>
			<p class="mt-3 mb-3"><a id="font18" href="friends.html" class="text-white">Cancel</a></p>	
</form>

		  </div>
  </div>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="//cdn.ably.io/lib/ably.min-1.js"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
<script>window.jQuery || document.write('<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"><\/script>')</script><script src="js/bootstrap.bundle.min.js"></script>
<script>
  let db = new Dexie("users");
  db.version(1).stores({
      settings: '++id,name,email'
  });

  let fdb = new Dexie("na");
  fdb.version(1).stores({
      connections: '++id,uid,name,email,myStatus,friendStatus,connectionStatus,inviteCode'
  });

  function makeid(length) {
    var result           = '';
    var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }

  $(document).ready(function(){
    document.getElementById("sbmt").disabled = true;

    db.settings.get(1)
    .then(function (user) {
      document.getElementById("senderName").value = user.name;
      let inviteCode = makeid(5);
      document.getElementById("inviteCode").value = inviteCode;
      document.getElementById("sbmt").disabled = false;
    })
    .catch(function(error){
      console.log(error)
    }) 
  });

  const sendInvite = async (e) => {
    e.preventDefault();
    document.getElementById("sbmt").disabled = true;
    let invitee = await fdb.connections.get({email:document.getElementById("inputEmail").value})
    
    console.log(invitee)
    if(invitee){
      //user already invited
      alert(document.getElementById("inputName").value+' already invited')
      document.getElementById("sbmt").disabled = false;
      return true;
    }
    
    const data = new URLSearchParams();
    var formData =  new FormData(e.srcElement);
    const plainFormData = Object.fromEntries(formData.entries());
    const formDataJsonString = JSON.stringify(plainFormData);

    console.log(formDataJsonString);
    
    const settings = {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: formDataJsonString
    };
    try {
      const fetchResponse = await fetch(`https://api.noctis-alba.com/inviteFriend`, settings);
      const data = await fetchResponse.json();
      console.log(data);
      if(data.success === true){
        //Save user to database
        fdb.connections.add({
          email: plainFormData.inputEmail,
          name: plainFormData.inputName,
          inviteCode: plainFormData.inviteCode,
          connectionStatus: "pending"
        })
        .then((result) =>{
          // direct to confirmation
          window.document.location.href = "/invite-confirmation.html"
        })
      }else{
        //something went wrong. todo: add error message
        document.getElementById("sbmt").disabled = false;
      }
    } catch (e) {
      document.getElementById("sbmt").disabled = false;
      return e;
    }
  }
</script>
</html>
