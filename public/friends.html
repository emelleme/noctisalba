<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="">
    <title>Noctis Alba · Contacts</title>

    <link rel="canonical" href="">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
	  <link href="bootstrap4-toggle.min.css" rel="stylesheet">
<!-- Custom CSS -->
	  <link href="custom.css" rel="stylesheet">


  </head>
  <body class="text-center">
    <!-- Navigation -->
    <a class="" href="index.html"><img class="logo" src="images/NA-Logo.svg" alt="Noctis Alba Logo"></a>

	  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
      <span class="navbar-brand"></span>
      <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
            <a class="nav-link " href="friends.html"><i class="fa fa-address-book"></i> Friends<span class="sr-only">(current)</span></a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="invite-friends.html"><i class="fa fa-envelope"></i> Invite </a>
          </li> <li class="nav-item">
            <a class="nav-link" href="features.html"><i class="fa fa-star"></i> Features </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about-us.html"><i class="fa fa-address-card"></i> About us</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="help.html"><i class="fa fa-question-circle"></i> Help</a>
          </li>
            </ul>
          <ul class="navbar-nav ml-auto" id="userMenu">
              <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown03" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <img src="images/avatar-icon.png" id="avatarIcon" height="21" width="21" style="margin-right:5px">
              <span id="userName"></span></a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdown03">
              <a class="dropdown-item" href="my-account.html"><i class="fa fa-gear"></i> Settings</a>
              <a class="dropdown-item" href="index.html"><i class="fa fa-sign-out"></i> Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

<div class="container">
<h1 class="text-left">Friends</h1>
<p class="text-left">See whose up and whose ready to connect. You can also choose who you allow to sees if you are up or not. <b> After 30 min of inactivity the site will automatically show you as asleep.</p>

<p class="text-left text-uppercase"><a href="invite-friends.html"><i class="fa fa-plus-circle" aria-hidden="true" style="margin-right:8px"></i>Invite Friends</a></p>

 <div class="row color-cyan" style="display:none"><!-- hidden -->
	<div class="col-md-3">
      <div class="sub-titles">YOUR COMMUNICATION SET</div>
		  <div class="form-group">
    <select class="form-control" id="exampleFormControlSelect1">
      <option>By Individual</option>
      <option>By All</option>
    </select>
  </div>
    </div>
    <div class="col-md-6">
		<div class="sub-titles">CONTACTS</div>
<div class="input-group float-left" style="max-width:376px;">
  <input class="form-control" type="text" placeholder="Search your Contacts" aria-label="Search">
  <div class="input-group-append">
    <span class="input-group-text red lighten-3" id="basic-text1"><i class="fa fa-search text-grey"
        aria-hidden="true"></i></span>
	  
  </div>

		</div>
			<div class="float-right" style="padding-top:8px;"><a href="invite-friends.html" class="color-yellow"><i class="fa fa-plus-circle" aria-hidden="true"></i> Invite Friends</a></div>
	 </div>
    <div class="col-md-3">
<div class="sub-titles">STATUS<br>
		<span class="text-white-50">
			UP (3)<br>
      Zzz (3)<br>
</span>
</div>
    </div>

</div>
	  <form>
<table class="table table-striped">
  <thead>
    <tr>
      <th width="45%" scope="col" class="text-left">My Status<small> (What friend sees)</small></th>
      <th width="30%" scope="col" class="text-right">Friend</th>
      <th width="45%" scope="col" class="text-center"><span id="text">Friend's Status</span></th>
    </tr>
  </thead>
  <tbody>
    <!-- <tr>
      <th scope="row" class="text-left">
        <input class="switch" type="checkbox" checked data-toggle="toggle" data-on="UP" data-off="ZZZ" data-onstyle="success" data-offstyle="secondary" aria-label="status">
      </th>
      <td class="text-right"><i class="fa fa-user"></i><span class="contact-names">Rachel Duke</span></td>
      <td><strong>UP</strong></td>
    </tr> -->
  </tbody>
</table>
  </form>
<div class="row">
<!-- <div class="col text-left">
  Showing 1 - 6 of 12
</div> -->
<div class="col">
<nav aria-label="Page navigation example">
  <ul class="pagination justify-content-end">
    <li class="page-item disabled">
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>
    <li class="page-item active" ><a class="page-link" href="#">1</a></li>
    <li class="page-item"><a class="page-link" href="#">2</a></li>
    <!-- <li class="page-item"><a class="page-link" href="#">3</a></li> -->
    <li class="page-item">
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>
  </ul>
</nav>
</div>
</div>
	
</div>

<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="AlertLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AlertLabel">Alert!</h5>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="Close" >
          <span aria-hidden="true">&times;</span>
        </button>
		  
      </div>
      <div class="modal-body">
		  <!-- alert -->
		   <div id="alertBox" class="alert alert-success text-left">
   <!-- <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> -->
            
        </div>
		    <!-- end alert -->
		  
      </div><!-- end modal body -->
		
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="closeModal()">Ok!</button>
      </div>
		
    </div>
  </div>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="AlertLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AlertLabel">Loading...</h5>
        
      
      </div>
      <div class="modal-body">
      <!-- alert -->
       <div id="alertBox" class="alert alert-success text-left">
   <!-- <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> -->
            Loading your friends. One moment...
        </div>
        <!-- end alert -->
      
      </div><!-- end modal body -->
    
    
    </div>
  </div>
</div>

<div class="modal fade" id="inviteModal" tabindex="-1" role="dialog" aria-labelledby="AlertLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AlertLabel">Invite accepted!</h5>
        
      
      </div>
      <div class="modal-body">
      <!-- alert -->
       <div id="inviteBox" class="alert alert-success text-left">
   <!-- <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> -->
            Your invite was accepted!
        </div>
        <!-- end alert -->
      
      </div><!-- end modal body -->
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="closeModal()">Ok!</button>
      </div>
    
    </div>
  </div>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://unpkg.com/dexie-export-import/dist/dexie-export-import.js"></script>
<script src="//cdn.ably.io/lib/ably.min-1.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="js/bootstrap4-toggle.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script>
  var ably = new Ably.Realtime('FoCmEw.GR0MCw:l2bFPn7u_Bj7fMzV');
  
  let closeModal = () => {
    $('#alertModal').modal('hide');
  }
  let db = new Dexie("users");
  db.version(1).stores({
      settings: 'id,name,email'
  });

  let fdb = new Dexie("na");
  fdb.version(2).stores({
      connections: '++id,uid,name,email,myState,friendState,connectionState,inviteCode,*publicAddress'
  });

  let invitedb = new Dexie("invites");
  invitedb.version(1).stores({
      incoming: '++id,code'
  });

  // To-do: resolve incoming invites

  fireAuth = async (did) => {
    const settings = {
        method: 'GET',
        headers: {
            Accept: 'application/json',
            'X-Custom-DID': did
        }
    };
    try {
        const fetchResponse = await fetch(`https://api.noctis-alba.com/getJWT`, settings);
        const data = await fetchResponse.body;
        console.log(data);
        return data;
    } catch (e) {
        return e;
    }
  }
  let magic = new Magic("pk_live_09D4E08E8CBA5F91");

  let checkInvites = async (invites) => {
    let did = await magic.user.getIdToken();
    const { email } = await magic.user.getMetadata();
    const init = {
      method: 'POST',
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json",
        'X-Custom-DID': did
      },
      body: JSON.stringify({code:invites.inviteCode,email:email})
    };
    try {
      const fetchResponse = await fetch(`https://api.noctis-alba.com/checkInvite`, init);
      const data = await fetchResponse.json();
      console.log(data);
      if(data){
        if(data.data.publicAddress !== undefined){
          //Save friend to database
          await fdb.connections
          .where("inviteCode")
          .equals(data.data.inviteCode)
          .modify({publicAddress: data.data.publicAddress,connectionState:"ZZZ"})
          // await invitedb.incoming.delete(1);
          return true;
        }else{
          return false;
        }
        // .then( async (result) => {
        //   await invitedb.incoming.delete(1);
        //   // direct to confirmation
        //   var newRow = $("<tr>");
        //     var cols = "";

        //     cols += `<th scope="row" class="text-left">
        //       <input class="newSwitch" type="checkbox" data-toggle="toggle" data-on="UP" data-off="ZZZ" data-onstyle="success" data-offstyle="secondary" aria-label="State">
        //     </th>`;
        //     cols += `<td class="text-right"><i class="fa fa-user"></i><span class="contact-names">${friend.invitedBy}</span></td>`;
        //     cols += `<td><strong>${result.connectionState}</strong></td>`;

        //     newRow.append(cols);
        //     $("table.table-striped").append(newRow);
        //     $('.newSwitch').bootstrapToggle();
        // })
      }else{
        //something went wrong. todo: add error message
        return false;
      }
    } catch (e) {
      return false;
    }
  }

  /* 3️⃣ Implement Render Function */
  const render = async () => {
    
    db.settings.get(1)
    .then(async function (user) {
      if(user === undefined){
        //Redirect to my account
        window.document.location.href = "/my-account.html";
        return true
      }

      if(user.publicAddress === undefined){
        //Redirect to my account
        window.document.location.href = "/my-account.html";
        return true
      }

      const chanId = user.publicAddress.substr(user.publicAddress.length - 6);
      // $('#userMenu').show();
      if(user.name === undefined)
        window.document.location.href = "/my-account.html"
      document.getElementById("userName").innerHTML = user.name;
      (user.image  !== undefined ? document.getElementById("avatarIcon").src = user.image : console.log('no image'));
     
      const ably = new Ably.Realtime({key:'FoCmEw.GR0MCw:l2bFPn7u_Bj7fMzV'});
      ably.connection.on('connected', function() {
        const channel = ably.channels.get("chan:"+chanId);
        channel.subscribe( async function(message) {
          console.log(message.data);
          await fdb.connections
          .where("publicAddress")
          .equals(message.data.from).modify({friendState: message.data.state});
          let friend = await fdb.connections
          .where("publicAddress")
          .equals(message.data.from).first()
          console.log(friend)
          document.getElementById(message.data.chanId+'_state').innerHTML = message.data.state;
          document.getElementById(message.data.chanId+'_state').className = '';
          document.getElementById(message.data.chanId+'_state').className = message.data.state.toLowerCase();
          document.getElementById("alertBox").innerHTML = friend.name + " is " + message.data.state + "!";
          $('#alertModal').modal('show');
          await exportFriends();
          // alert(message.data.state+"!!")
        });
        console.log('connected')
      });

      
      // await exportFriends();
    })
    .catch(function(error){
      // window.document.location.href = "/my-account.html"
      console.log(error)
    })
  };

  let toggleState = async (chanId, state) => {
    let {publicAddress} = await magic.user.getMetadata();
    var channel = ably.channels.get("chan:"+chanId);
    channel.publish("stateChange",{ "from":publicAddress, "chanId":publicAddress.substr(publicAddress.length - 6), "state": state }, async (err)=>{
      if(err) {
        console.log('Unable to publish message; err = ' + err.message);
      } else {
        console.log('Message successfully sent');
        await exportFriends();
      }
    });
  }

  let importData = async (data) => {
    const base64 = await fetch(data);
    const blob = await base64.blob();
    await importInto(fdb, blob, [{overwriteValues:true}]);
  }


  let exportFriends = async () => {
    //
    // Export to Blob
    //
    let did = await magic.user.getIdToken();
    const blob = await fdb.export(fdb, [{prettyJson: true}]);
    let reader = new FileReader();
    console.log(blob)
    reader.readAsDataURL(blob); 
    reader.onloadend = async function() {
      let base64data = reader.result;                
      // console.log(base64data);
      const init = {
        method: 'POST',
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          'X-Custom-DID': did
        },
        body: JSON.stringify({data:base64data})
      };
      try {
        const fetchResponse = await fetch(`https://api.noctis-alba.com/syncFriends`, init);
        const data = await fetchResponse.json();
        console.log(data);
        if(data){
          
          
        }else{
          //something went wrong. todo: add error message
        }
      } catch (e) {
        return e;
      }
      return true;
    };
  }

  let getFriends = async () => {
    //
    // Export to Blob
    //
    let did = await magic.user.getIdToken();
               
      // console.log(base64data);
      
      try {
        const init = {
          method: 'GET',
          headers: {
            "Content-Type": "text/plain",
            'X-Custom-DID': did
          }
        };
        const fetchResponse = await fetch(`https://api.noctis-alba.com/getFriends`, init);
        const data = await fetchResponse.blob();
        console.log(data.size);
        if(data.size > 20){
          let tt = await data.text();
          const importData = atob(tt.substring(22,tt.length));
          const bytes = new TextEncoder().encode(importData);
          const blob = new Blob([bytes]);
          const b2f = blobToFile(blob);
          console.log(b2f)
          const imp = await fdb.import(b2f,{overwriteValues:true});
          console.log(imp)
          
        }else{
          //something went wrong. todo: add error message
        }
      } catch (e) {
        console.log(e)
        return e;
      }
      return true;
  }

  function blobToFile(theBlob){
      //A Blob() is almost a File() - it's just missing the two properties below which we will add
      theBlob.lastModifiedDate = new Date();
      theBlob.name = 'temp-file.json';
      return theBlob;
  }
// function myFunction() {
//   // Get the checkbox
//   var checkBox = document.getElementById("myCheck");
//   // Get the output text
//   var text = document.getElementById("text");

//   // If the checkbox is checked, display the output text
//   if (checkBox.checked == true){
//     text.style.display = "Up";
//   } else {
//     text.style.display = "none";
//   }
// }
  $(document).ready(async function(){

    $('#inviteModal').on('hide.bs.modal', function (e) {
      // do something...
      location.reload();
    })
    $('#loadingModal').modal('show');
    
    const isLoggedIn = await magic.user.isLoggedIn();
    
    if (!isLoggedIn) {
      window.document.location.href = "/"
      // initialize database
      
    }
    await loadFriends();
    render();
    
    $('#loadingModal').modal('hide');
    $(".newSwitch").on("click", e => {
      console.log(e.data("id"));
    })

    $('.newSwitch').change(function(e) {
      console.log(e);
    })

    
    
  });

  const displayFriends = async () => {
    //
      // Get friends
      //
      fdb.connections.where("connectionState").notEqual("blocked")
      .each(function (friend){
        //load friends into table
        // console.log(friend);
        let state = friend.connectionState;
        let mystate = ((friend.myState !== null) ? friend.myState : "off");
        let disableSwitch = "";
        if(friend.friendState !== undefined){
          state = friend.friendState;
        }
        if(friend.connectionState !== 'pending'){
          disableSwitch = "";
        }
        const chanId = (friend.publicAddress !== undefined ? friend.publicAddress.substr(friend.publicAddress.length - 6) : "");
        var newRow = $("<tr>");
        var cols = "";
        cols += `<th scope="row" class="text-left">
          <input id="${chanId}" class="newSwitch" ${disableSwitch} data-pubkey="${friend.publicAddress}" type="checkbox" data-toggle="toggle" data-on="UP" data-off="ZZZ" data-onstyle="success" data-offstyle="secondary" aria-label="State">
        </th>`;
        cols += `<td class="text-right"><i class="fa fa-user"></i><span class="contact-names">${friend.name}</span></td>`;
        cols += `<td><strong><span id="${chanId}_state" class="${state.toLowerCase()}">${state}</span></strong></td>`;

        newRow.append(cols);
        $("table.table-striped").append(newRow);
        $('#'+chanId).bootstrapToggle(mystate);
        return new Promise();
      })
      .then(() => {
        $('.newSwitch').bootstrapToggle();
        $('.newSwitch').on("change", async function(e) {
          let state = ($(this).prop('checked') === true ? e.target.dataset.on : e.target.dataset.off)
          await fdb.connections
          .where("publicAddress")
          .equals(e.target.dataset.pubkey)
          .modify({myState: ($(this).prop('checked') === true ? "on" : "off")});
          toggleState(e.target.id,state)
          console.log(e);
        })
      })
      .catch(function(error) {
        alert ("Ooops: " + error);
      });
  }

  const loadFriends = async () => {
    //
      // Load Friends
      //
      let friends = await getFriends();

      //
      // Check invites
      //
      invites = await fdb.connections.where("connectionState").equals("pending").toArray()
      if(invites.length > 0){
        let iv = false;
        await invites.forEach(async (invite) => {
          iv = await checkInvites(invite);
          console.log(iv)
          if(iv){
            await exportFriends();
            $("#inviteModal").modal('show');
            $('#loadingModal').modal('hide');
          }
            
        })
      }else{
        await displayFriends();
      }
      
      
        
      // console.log(await fdb.connections.where("connectionState").notEqual("blocked"))
      
  }

  /* 5️⃣ Implement Logout Handler */
  const handleLogout = async () => {
        await db.delete();
        await fdb.delete();
        await invitedb.delete();
        await magic.user.logout();
        render();
      };
</script>
</html>
