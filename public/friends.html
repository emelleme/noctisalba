<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="">
    <title>Noctis Alba · Contacts</title>

    <link rel="canonical" href="">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
	  <link href="bootstrap4-toggle.min.css" rel="stylesheet">
<!-- Custom CSS -->
	  <link href="custom.css" rel="stylesheet">


  </head>
  <body class="text-center">
<a class="" href="index.html"><img class="logo" src="images/NA-Logo.svg" alt="Noctis Alba Logo"></a>
	  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
<span class="navbar-brand"></span>
  <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarCollapse">
    <ul class="navbar-nav mr-auto">
            <li class="nav-item">
        <a class="nav-link" href="features.html"><i class="fa fa-star"></i> Features <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="about-us.html"><i class="fa fa-address-card"></i> About us</a>
      </li>
		<li class="nav-item">
        <a class="nav-link" href="help.html"><i class="fa fa-question-circle"></i> Help</a>
      </li>
		 <li class="nav-item active">
        <a class="nav-link" href="contacts.html"><i class="fa fa-address-book"></i> Friends</a>
      </li>
		 <li class="nav-item">
        <a class="nav-link" href="invite-friends.html"><i class="fa fa-envelope"></i> Invite</a>
      </li>

      <!--<li class="nav-item">
        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
      </li>

    <form class="form-inline mt-2 mt-md-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>-->
		    </ul>

			<ul class="navbar-nav ml-auto">
				  <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="dropdown03" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <img src="images/avatar-icon.png" height="21" width="21" style="margin-right:5px"> 
          <span id="userName"></a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdown03">
          <a class="dropdown-item" href="settings.html#collapseSettings"><i class="fa fa-gear"></i> Settings</a>
          <a class="dropdown-item" href="index.html"><i class="fa fa-sign-out"></i> Logout</a>
        </div>
      </li>
</ul>
 
  </div>
</nav>

<div class="container">
<h1 class="text-left">Friends</h1>
<p class="text-left">See whose up and whose ready to connect. You can also choose who sees you are up or not.</p>

<p class="text-left text-uppercase"><a href="invite-friends.html"><i class="fa fa-plus-circle" aria-hidden="true" style="margin-right:8px"></i>Invite Friends</a></p>

 <div class="row color-cyan" style="display:none"><!-- hidden -->
	<div class="col-md-3">
      <div class="sub-titles">YOUR COMMUNICATION SET</div>
		  <div class="form-group">
    <select class="form-control" id="exampleFormControlSelect1">
      <option>By Individual</option>
      <option>By All</option>
    </select>
  </div>
    </div>
    <div class="col-md-6">
		<div class="sub-titles">CONTACTS</div>
<div class="input-group float-left" style="max-width:376px;">
  <input class="form-control" type="text" placeholder="Search your Contacts" aria-label="Search">
  <div class="input-group-append">
    <span class="input-group-text red lighten-3" id="basic-text1"><i class="fa fa-search text-grey"
        aria-hidden="true"></i></span>
	  
  </div>

		</div>
			<div class="float-right" style="padding-top:8px;"><a href="invite-friends.html" class="color-yellow"><i class="fa fa-plus-circle" aria-hidden="true"></i> Invite Friends</a></div>
	 </div>
    <div class="col-md-3">
<div class="sub-titles">STATUS<br>
		<span class="text-white-50">
			UP (3)<br>
      Zzz (3)<br>
</span>
</div>
    </div>

</div>
	  <form>
<table class="table table-striped">
  <thead>
    <tr>
      <th width="17%" scope="col" class="text-left">Your Status</th>
      <th width="69%" scope="col" class="text-right">Contacts</th>
      <th width="14%" scope="col" class="text-left"><span id="text">Friends Status</span></th>
    </tr>
  </thead>
  <tbody>
    <!-- <tr>
      <th scope="row" class="text-left">
        <input class="switch" type="checkbox" checked data-toggle="toggle" data-on="UP" data-off="ZZZ" data-onstyle="success" data-offstyle="secondary" aria-label="status">
      </th>
      <td class="text-right"><i class="fa fa-user"></i><span class="contact-names">Rachel Duke</span></td>
      <td><strong>UP</strong></td>
    </tr> -->
  </tbody>
</table>
  </form>
<div class="row">
<!-- <div class="col text-left">
  Showing 1 - 6 of 12
</div> -->
<div class="col">
<nav aria-label="Page navigation example">
  <ul class="pagination justify-content-end">
    <li class="page-item disabled">
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>
    <li class="page-item active" ><a class="page-link" href="#">1</a></li>
    <li class="page-item"><a class="page-link" href="#">2</a></li>
    <!-- <li class="page-item"><a class="page-link" href="#">3</a></li> -->
    <li class="page-item">
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>
  </ul>
</nav>
</div>
</div>
	
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://unpkg.com/dexie-export-import/dist/dexie-export-import.js"></script>
<script src="//cdn.ably.io/lib/ably.min-1.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="js/bootstrap4-toggle.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script>
  var ably = new Ably.Realtime('FoCmEw.GR0MCw:l2bFPn7u_Bj7fMzV');
  
  let db = new Dexie("users");
  db.version(1).stores({
      settings: '++id,name,email'
  });

  let fdb = new Dexie("na");
  fdb.version(1).stores({
      connections: '++id,uid,name,email,myState,friendState,connectionState,inviteCode'
  });

  let invitedb = new Dexie("invites");
  invitedb.version(1).stores({
      incoming: '++id,code'
  });

  // To-do: resolve incoming invites

  fireAuth = async (did) => {
    const settings = {
        method: 'GET',
        headers: {
            Accept: 'application/json',
            'X-Custom-DID': did
        }
    };
    try {
        const fetchResponse = await fetch(`https://api.noctis-alba.com/getJWT`, settings);
        const data = await fetchResponse.body;
        console.log(data);
        return data;
    } catch (e) {
        return e;
    }
  }
  let magic = new Magic("pk_live_09D4E08E8CBA5F91");

  let checkInvites = async (did,invites) => {
    const init = {
      method: 'POST',
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json",
        'X-Custom-DID': did
      },
      body: JSON.stringify(invites)
    };
    try {
      const fetchResponse = await fetch(`https://api.noctis-alba.com/getInvites`, init);
      const data = await fetchResponse.json();
      console.log(data);
      if(data){
        
        //Save friend to database
        let friend = data[0];
        fdb.connections.add({
          name: data[0].invitedBy,
          inviteCode: data[0].inviteCode,
          friendState:"UP",
          connectionState: "active"
        })
        .then( async (result) => {
          await invitedb.incoming.delete(1);
          // direct to confirmation
          var newRow = $("<tr>");
            var cols = "";

            cols += `<th scope="row" class="text-left">
              <input class="newSwitch" type="checkbox" data-toggle="toggle" data-on="UP" data-off="ZZZ" data-onstyle="success" data-offstyle="secondary" aria-label="State">
            </th>`;
            cols += `<td class="text-right"><i class="fa fa-user"></i><span class="contact-names">${friend.invitedBy}</span></td>`;
            cols += `<td><strong>${result.connectionState}</strong></td>`;

            newRow.append(cols);
            $("table.table-striped").append(newRow);
            $('.newSwitch').bootstrapToggle();
        })
      }else{
        //something went wrong. todo: add error message
      }
    } catch (e) {
      return e;
    }
  }
  /* 3️⃣ Implement Render Function */
  const render = async () => {
        const isLoggedIn = await magic.user.isLoggedIn();

        if (!isLoggedIn) {
          window.document.location.href = "/"
          // initialize database
        }
        let did = await magic.user.getIdToken();
        const { email, publicAddress } = await magic.user.getMetadata();
        const chanId = publicAddress.substr(publicAddress.length - 6);
        console.log(chanId)
        ably.connection.on('connected', function() {
          const channel = realtime.channels.get("chan:"+chanId);
          console.log('connected')
        });
        //
        // Check invites
        //
        const userMetadata = await magic.user.getMetadata();
        
        invites = await invitedb.incoming.orderBy("code").toArray()
        console.log(did);
        if(invites.length > 0)
          checkInvites(did,invites);
        
        
        //
        // Get friends
        //
        fdb.connections.where("connectionState").notEqual("blocked")
        .each(function (friend){
          //load friends into table
          console.log('friend loaded');
          let state = "pending";
          if(friend.friendState){
            state = friendState;
          }

          var newRow = $("<tr>");
          var cols = "";

          cols += `<th scope="row" class="text-left">
            <input class="newSwitch" type="checkbox" data-toggle="toggle" data-on="UP" data-off="ZZZ" data-onstyle="success" data-offstyle="secondary" aria-label="State">
          </th>`;
          cols += `<td class="text-right"><i class="fa fa-user"></i><span class="contact-names">${friend.name}</span></td>`;
          cols += `<td><strong>${state}</strong></td>`;

          newRow.append(cols);
          $("table.table-striped").append(newRow);
          $('.newSwitch').bootstrapToggle();
        })
        .catch(function(error) {
            //
            // Finally don't forget to catch any error
            // that could have happened anywhere in the
            // code blocks above.
            //
            alert ("Ooops: " + error);
        });
      
        const blob = await fdb.export(fdb, [{prettyJson: true}]);
        let reader = new FileReader();
        reader.readAsDataURL(blob); 
        reader.onloadend = function() {
        let base64data = reader.result;                
        console.log(base64data);
 }
       

      };


let exportData = async () => {
  //
  // Export to Blob
  //
  const blob = await exportDB(fdb, [options]);
  console.log(blob)
  return true;
}
function myFunction() {
  // Get the checkbox
  var checkBox = document.getElementById("myCheck");
  // Get the output text
  var text = document.getElementById("text");

  // If the checkbox is checked, display the output text
  if (checkBox.checked == true){
    text.style.display = "Up";
  } else {
    text.style.display = "none";
  }
}

  $(document).ready(function(){
    render();
    $(".switch").on("click", e => {
      console.log(e.data("id"));
    })

    db.settings.get(1)
    .then(function (user) {
      document.getElementById("userName").innerHTML = user.name;
    })
    .catch(function(error){
      console.log(error)
    }) 

    
  });
</script>
</html>