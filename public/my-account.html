<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="">
    <title>Noctis Alba · Create Account</title>

    <link rel="canonical" href="">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
<link href="bootstrap.min.css" rel="stylesheet">
	      <link href="signin.css" rel="stylesheet">
	  	  <!-- Custom CSS -->
<link href="custom.css" rel="stylesheet">

  </head>
  <body id="create-account" class="text-center">
<a class="" href="index.html"><img class="logo" src="images/NA-Logo.svg" alt="Noctis Alba Logo"></a>
	  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
		  <span class="navbar-logo-area"></span>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarCollapse">
    <ul class="navbar-nav mr-auto">
   <li class="nav-item">
		  <a class="nav-link" href="features.html"><i class="fa fa-star"></i> Features <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="about-us.html"><i class="fa fa-address-card"></i> About us</a>
      </li>
		<li class="nav-item">
        <a class="nav-link" href="help.html"><i class="fa fa-question-circle"></i> Help</a>
      </li>
      <!--<li class="nav-item">
        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
      </li>

    <form class="form-inline mt-2 mt-md-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>-->
		    </ul>
  </div>
</nav>
<div id="shape-circle" class="hidden-sm-down"></div>
    <form class="form-signin" onsubmit="saveUser(event)">
      <h1 class="mb-3 font-weight-normal">My Account</h1>
      
      <div class="form-group">
        <label for="inputName" class="sr-only">Your Name</label>
        <input id="inputName" type="text" class="form-control" aria-label="name" placeholder="Full Name" >
      </div>
      <div class="form-group">
        <label for="inputEmail" class="sr-only">Email address</label>
        <input type="email" disabled id="inputEmail" class="form-control" placeholder="Email Address" aria-label="email address" autofocus>
        </div>
      <button id="sbmt" disabled class="btn btn-lg btn-primary btn-block" type="submit">Save</button>
      <p class="mt-3 mb-2">By signing up, you agree to Night Chatter's <a href="terms-of-use.html" class="text-white">Terms &amp; Conditions</a> &nbsp;|&nbsp; <a href="privacy-policy.html" class="text-white">Privacy practices</a></p>
    
    </form>
    
</body>
  <script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="https://unpkg.com/dexie-export-import/dist/dexie-export-import.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
  <script>

    function isEmpty(obj) {
        return Object.keys(obj).length === 0;
    }

    let getUser = async (did) => {
      const settings = {
          method: 'GET',
          headers: {
              "Accept": "application/json",
              "Content-Type": "application/json",
              "X-Custom-DID": did
          }
      };
      try {
          const fetchResponse = await fetch(`https://api.noctis-alba.com/getUser`, settings);
          const data = await fetchResponse.json();
          console.log(data);
          return data;
      } catch (e) {
          return e;
      }
    }

    let syncUser = async (did,blob) => {
      //
      // Export to Blob
      //
      let reader = new FileReader();
      reader.readAsDataURL(blob); 
      reader.onloadend = async function() {
        let base64data = reader.result;
        const init = {
          method: 'POST',
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            'X-Custom-DID': did
          },
          body: JSON.stringify({data:base64data})
        };
        try {
          const fetchResponse = await fetch(`https://api.noctis-alba.com/syncUser`, init);
          const resp = await fetchResponse.json();
          console.log(resp);
          return resp;
          
        } catch (e) {
          return e;
        }
        return true;
      }
    }

    $(document).ready(function(){
      render();
    });

    let magic = new Magic("pk_live_09D4E08E8CBA5F91");
    let db = new Dexie("users");
    db.version(1).stores({
        settings: '++id,name,email,uid,publicAddress'
    });
    
    const saveUser = async (e) => {
      e.preventDefault()
      document.getElementById("sbmt").disabled = true;
      db.settings.get({email:document.getElementById("inputEmail").value})
      .then(function (user) {
        return db.settings.update(user.id,{name: document.getElementById("inputName").value})
      })
      .then (async function(){
        let did = await magic.user.getIdToken();
        const blob = await db.export(db, [{prettyJson: true}]);
        let result = await syncUser(did,blob)
        window.document.location.href = "/friends.html"
        })
        .catch(function(error) {
            console.log ("Ooops: " + error);
        });
    }


      /* 3️⃣ Implement Render Function */
      const render = async () => {
        const isLoggedIn = await magic.user.isLoggedIn();

        if (isLoggedIn) {
          let did = await magic.user.getIdToken();
          const userMetadata = await magic.user.getMetadata();
          document.getElementById("inputEmail").value = userMetadata.email;

          let userData = await getUser(did);
          if(!isEmpty(userData)){
            //todo: import database
          } else {
            //write initial data to database
            db.open()
            .then(function(){
              return db.settings.get({email:userMetadata.email});
            })
            .then(function (user) {
              console.log(user)
              if(user)
                document.getElementById("inputName").value = user.name;
              else
                db.settings.add({email: document.getElementById("inputEmail").value,uid:userMetadata.issuer,publicAddress:userMetadata.publicAddress})
              document.getElementById("sbmt").disabled = false;
            }).catch(function(error) {
              console.log ("Ooops: " + error);
            });
          }
          
        }else{
          window.document.location.href = "/"
        }

      };
      

      /* 5️⃣ Implement Logout Handler */
      const handleLogout = async () => {
        await magic.user.logout();
        render();
      };
	</script>
</html>
