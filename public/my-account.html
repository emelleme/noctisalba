<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="">
    <title>Noctis Alba · Create Account</title>

    <link rel="canonical" href="">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
<link href="bootstrap.min.css" rel="stylesheet">
	      <link href="signin.css" rel="stylesheet">
	  	  <!-- Custom CSS -->
<link href="custom.css" rel="stylesheet">

  </head>
  <body id="create-account" class="text-center">
<a class="" href="index.html"><img class="logo" src="images/NA-Logo.svg" alt="Noctis Alba Logo"></a>
<nav class="navbar navbar-expand-md navbar-dark fixed-top">
  
  <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarCollapse">
    <ul class="navbar-nav mr-auto">
    <li class="nav-item">
        <a class="nav-link" href="friends.html"><i class="fa fa-address-book"></i> Friends<span class="sr-only">(current)</span></a>
      </li>
    <li class="nav-item">
        <a class="nav-link" href="invite-friends.html"><i class="fa fa-envelope"></i> Invite </a>
      </li> <li class="nav-item">
        <a class="nav-link " href="features.html"><i class="fa fa-star"></i> Features </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="about-us.html"><i class="fa fa-address-card"></i> About us</a>
      </li>
    <li class="nav-item">
        <a class="nav-link" href="help.html"><i class="fa fa-question-circle"></i> Help</a>
      </li>
        </ul>
      <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="dropdown03" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <img src="images/avatar-icon.png" id="avatarIcon" height="21" width="21" style="margin-right:5px">
          <span id="userName"></span></a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdown03">
          <a class="dropdown-item" href="my-account.html"><i class="fa fa-gear"></i> Settings</a>
          <a class="dropdown-item" href="index.html"><i class="fa fa-sign-out"></i> Logout</a>
        </div>
      </li>
    </ul>
  </div>
</nav>
<div id="shape-circle" class="hidden-sm-down"></div>
    <form class="form-signin" onsubmit="saveUser(event)">
      <h1 class="mb-3 font-weight-normal">My Account</h1>
      
      <div class="form-group">
        <div class="picture-container">
          <div class="picture">
              <img src="https://lh3.googleusercontent.com/LfmMVU71g-HKXTCP_QWlDOemmWg4Dn1rJjxeEsZKMNaQprgunDTtEuzmcwUBgupKQVTuP0vczT9bH32ywaF7h68mF-osUSBAeM6MxyhvJhG6HKZMTYjgEv3WkWCfLB7czfODidNQPdja99HMb4qhCY1uFS8X0OQOVGeuhdHy8ln7eyr-6MnkCcy64wl6S_S6ep9j7aJIIopZ9wxk7Iqm-gFjmBtg6KJVkBD0IA6BnS-XlIVpbqL5LYi62elCrbDgiaD6Oe8uluucbYeL1i9kgr4c1b_NBSNe6zFwj7vrju4Zdbax-GPHmiuirf2h86eKdRl7A5h8PXGrCDNIYMID-J7_KuHKqaM-I7W5yI00QDpG9x5q5xOQMgCy1bbu3St1paqt9KHrvNS_SCx-QJgBTOIWW6T0DHVlvV_9YF5UZpN7aV5a79xvN1Gdrc7spvSs82v6gta8AJHCgzNSWQw5QUR8EN_-cTPF6S-vifLa2KtRdRAV7q-CQvhMrbBCaEYY73bQcPZFd9XE7HIbHXwXYA=s200-no" class="picture-src" id="wizardPicturePreview" title="">
              <input type="file" id="wizard-picture" class="">
          </div>
           <h6 class="">Choose Picture</h6>
  
      </div>
        <label for="inputName" class="sr-only">Your Name</label>
        <input id="inputName" type="text" class="form-control" aria-label="name" placeholder="Full Name" >
      </div>
      <div class="form-group">
        <label for="inputEmail" class="sr-only">Email address</label>
        <input type="email" disabled id="inputEmail" class="form-control" placeholder="Email Address" aria-label="email address" autofocus>
        </div>
      <button id="sbmt" disabled class="btn btn-lg btn-primary btn-block" type="submit">Save</button>
      <p class="mt-3 mb-2">By signing up, you agree to Noctis Alba's <a href="terms-of-use.html" class="text-white">Terms &amp; Conditions</a> &nbsp;|&nbsp; <a href="privacy-policy.html" class="text-white">Privacy practices</a></p>
    
    </form>
    <div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="AlertLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="AlertLabel">Loading...</h5>
            
          
          </div>
          <div class="modal-body">
          <!-- alert -->
           <div id="alertBox" class="alert alert-success text-left">
       <!-- <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> -->
                Loading your settings. One moment...
            </div>
            <!-- end alert -->
          
          </div><!-- end modal body -->
        
        
        </div>
      </div>
    </div>
</body>
  <script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="https://unpkg.com/dexie-export-import/dist/dexie-export-import.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
  <script>
    let db = new Dexie("users");
    db.version(1).stores({
        settings: 'id,name,email,uid,publicAddress,image'
    });
    
    let fdb = new Dexie("na");
    fdb.version(2).stores({
        connections: '++id,uid,name,email,myState,friendState,connectionState,inviteCode,*publicAddress'
    });

    let invitedb = new Dexie("invites");
    invitedb.version(1).stores({
        incoming: '++id,code'
    });
  
    function isEmpty(obj) {
        return Object.keys(obj).length === 0;
    }

    let syncUser = async (did,blob) => {
      //
      // Export to Blob
      //
      let reader = new FileReader();
      reader.readAsDataURL(blob); 
      reader.onloadend = async function() {
        let base64data = reader.result;
        const init = {
          method: 'POST',
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            'X-Custom-DID': did
          },
          body: JSON.stringify({data:base64data})
        };
        try {
          const fetchResponse = await fetch(`https://api.noctis-alba.com/syncUser`, init);
          const resp = await fetchResponse.json();
          console.log(resp);
          return resp;
          
        } catch (e) {
          return e;
        }
        return true;
      }
    }

    $(document).ready(function(){
      $('#alertModal').modal('show');
      render();
    });

    let magic = new Magic("pk_live_09D4E08E8CBA5F91");
    
    const saveUser = async (e) => {
      e.preventDefault()
      document.getElementById("sbmt").disabled = true;
      db.settings.get({email:document.getElementById("inputEmail").value})
      .then(function (user) {
        return db.settings.update(user.id,{name: document.getElementById("inputName").value,image:document.getElementById("wizardPicturePreview").src})
      })
      .then (async function(){
        let did = await magic.user.getIdToken();
        const blob = await db.export(db, [{prettyJson: true}]);
        let result = await syncUser(did,blob)
        window.document.location.href = "/friends.html"
        })
        .catch(function(error) {
            console.log ("Ooops: " + error);
        });
    }


    function readURL(input) {
      if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function (e) {
              $('#wizardPicturePreview').attr('src', e.target.result);
          }
          reader.readAsDataURL(input.files[0]);
      }
    }

    let importUser = async (data) => {
      const base64 = await fetch(data);
      const blob = await base64.blob();
      return await db.import(blob, [{overwriteValues:true}]);
    }

    function blobToFile(theBlob){
      //A Blob() is almost a File() - it's just missing the two properties below which we will add
      theBlob.lastModifiedDate = new Date();
      theBlob.name = 'temp-file.json';
      return theBlob;
    }

    let getUser = async () => {
    //
    // Load User data from database
    //
    let did = await magic.user.getIdToken();
    
      const init = {
        method: 'GET',
        headers: {
          "Content-Type": "text/plain",
          'X-Custom-DID': did
        }
      };
      try {
        const fetchResponse = await fetch(`https://api.noctis-alba.com/getUser`, init);
        const data = await fetchResponse.blob();
        console.log(data.size);
        if(data.size > 20){
          let tt = await data.text();
          const importData = atob(tt.substring(22,tt.length));
          const bytes = new TextEncoder().encode(importData);
          const blob = new Blob([bytes]);
          const b2f = blobToFile(blob);
          console.log(b2f)
          const imp = await db.import(b2f,{overwriteValues:true});
          console.log(imp)
          return true;
        }else{
          //something went wrong. todo: add error message
          return false
        }
      } catch (e) {
        return e;
      }
      return false;
  }


      /* 3️⃣ Implement Render Function */
      const render = async () => {
        const isLoggedIn = await magic.user.isLoggedIn();
        $("#wizard-picture").change(function(){
            readURL(this);
        });
        if (isLoggedIn) {
          
          let did = await magic.user.getIdToken();
          const userMetadata = await magic.user.getMetadata();
          document.getElementById("inputEmail").value = userMetadata.email;
          

          
          let userData = await getUser(did);
          db.open()
          .then(function(){
            return db.settings.get({email:userMetadata.email});
          })
          .then(async function (user) {
            console.log(user)
            if(user !== undefined){
              if(user.name !== undefined)
                document.getElementById("userName").innerHTML = user.name;
              document.getElementById("inputName").value = (user.name !== undefined ? user.name : "");
              (user.image  !== undefined ? document.getElementById("avatarIcon").src = user.image : console.log('no image'));
              (user.image  !== undefined ? document.getElementById("wizardPicturePreview").src = user.image : console.log('no image'));
            }
            else{
              //write initial data to database
              
              if(userData){
                document.getElementById("sbmt").disabled = false;
                let user = await db.settings.get({email:userMetadata.email});
                if(user.name !== undefined)
                  document.getElementById("userName").innerHTML = user.name;
                document.getElementById("inputName").value = (user.name !== undefined ? user.name : "");
                (user.image  !== undefined ? document.getElementById("avatarIcon").src = user.image : console.log('no image'));
                (user.image  !== undefined ? document.getElementById("wizardPicturePreview").src = user.image : console.log('no image'));
              } else{
                await db.settings.add({id:1,email: document.getElementById("inputEmail").value,uid:userMetadata.issuer,publicAddress:userMetadata.publicAddress})
              }
            }
            
              
            document.getElementById("sbmt").disabled = false;
          }).catch(function(error) {
            console.log ("Ooops: " + error);
          });
          
          $('#alertModal').modal('hide');
          
        }else{
          window.document.location.href = "/"
        }

      };
      

      /* 5️⃣ Implement Logout Handler */
  const handleLogout = async () => {
        await db.delete();
        await fdb.delete();
        await invitedb.delete();
        await magic.user.logout();
        render();
      };
	</script>
</html>
