<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="Jekyll v4.1.1">
    <title>Noctis Alba · Sign In</title>

    <link rel="canonical" href="">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
<link href="bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
.alert{
    display: none;
}
      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
    <link href="signin.css" rel="stylesheet">

  </head>
  <body class="text-center">
<img class="logo" src="images/NA-Logo.svg" alt="Noctis Alba Logo">
	  <nav class="navbar navbar-expand-md navbar-dark fixed-top">
  <!-- <a class="navbar-brand" href="index.html">NOCTIS ALBA</a> -->
  <button class="navbar-toggler mr-auto" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
 <div class="collapse navbar-collapse" id="navbarCollapse">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="friends.html"><i class="fa fa-address-book"></i> Friends</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="invite-friends.html"><i class="fa fa-envelope"></i> Invite</a>
      </li> <li class="nav-item active">
        <a class="nav-link" href="features.html"><i class="fa fa-star"></i> Features </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="about-us.html"><i class="fa fa-address-card"></i> About us</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="help.html"><i class="fa fa-question-circle"></i> Help</a>
      </li>
    </ul>
</nav>
	  <div class="container-fluid">
<div class="row">
	  <div class="col-md-8 bg-img">
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		    <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <h2 id="na-tagline" class="text-white text-left ml-5"><strong>Insomnia is not something <br/>
			  you need to fix, it's an opportunity!<br/> 
	    -Noctis Alba</strong></h2>
<p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		  <p>&nbsp;</p>
	  </div>
	
<div class="col-md-4">
  <p>&nbsp;</p>
		  <p>&nbsp;</p>
		    <p>&nbsp;</p>
    <div id="app">
      Loading...
    </div>
    <p class="mt-3">By signing in, you agree Noctis Alba's <a href="terms-of-use.html">Terms &amp; Conditions</a> &nbsp;&amp;&nbsp; <a href="privacy-policy.html">Privacy practices</a></p>
      

</div><!-- end 2nd col -->
	</div>
		  </div>
	  
	  <!-- Modal -->
<div class="modal fade" id="ForgotPswdModal" tabindex="-1" role="dialog" aria-labelledby="ForgotPswdModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ForgotPswdModalLabel">Forgot Password</h5>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="Close" >
          <span aria-hidden="true">&times;</span>
        </button>
		  
      </div>
      <div class="modal-body">
		  <!-- alert -->
		   <div id="alertBox" class="alert alert-success text-left">
   <!-- <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> -->
            Sent successfully! Check your email address for instructions.
        </div>
		    <!-- end alert -->
		  <p class="text-left">Enter your email address to receive instructions on how to reset your password.</p>
		  <label for="inputEmail" class="sr-only">Email address</label>
  <input type="email" class="form-control" placeholder="Email address" autofocus>
		  <p>&nbsp;</p>
      </div><!-- end modal body -->
		
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">Send</button>
      </div>
		
    </div>
  </div>
</div>

</body>
  <script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@magic-ext/oauth/dist/extension.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="https://unpkg.com/dexie-export-import@latest/dist/dexie-export-import.js"></script>

  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
	<script>
    const urlParams = new URLSearchParams(window.location.search);
    const invite = urlParams.get('acceptInvite');
    console.log(invite)
    let invitedb = new Dexie("invites");
    invitedb.version(1).stores({
        incoming: '++id,code'
    });

    let db = new Dexie("users");
    db.version(1).stores({
        settings: 'id,name,email,uid,publicAddress'
    });

    let fdb = new Dexie("na");
    fdb.version(2).stores({
        connections: '++id,uid,name,email,myState,friendState,connectionState,inviteCode,*publicAddress'
    });

    $(document).ready( async function(){
      render();
      let invCount = 0;
     
       
    });

    let getUser = async (did) => {
      const settings = {
          method: 'GET',
          headers: {
              "Accept": "application/json",
              "Content-Type": "application/json",
              "X-Custom-DID": did
          }
      };
      try {
          const fetchResponse = await fetch(`https://api.noctis-alba.com/getUser`, settings);
          const data = await fetchResponse.blob();
          console.log(data);
          return data;
      } catch (e) {
          return e;
      }
    }


    let checkInvite = async (invite,email) => {
      let did = await magic.user.getIdToken();
      
      const init = {
        method: 'POST',
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          'X-Custom-DID': did
        },
        body: JSON.stringify({code:invite,email:email})
      };
      try {
          const fetchResponse = await fetch(`https://api.noctis-alba.com/checkInvite`, init);
          const resp = await fetchResponse.json();
          if(resp.data.publicAddress !== undefined){
            
          }
          // console.log(data);
          return resp;
      } catch (e) {
          return e;
      }
    }


    let magic = new Magic("pk_live_09D4E08E8CBA5F91");
    /* 3️⃣ Implement Render Function */
    const render = async () => {
      const isLoggedIn = await magic.user.isLoggedIn();

      /* Show login form if user is not logged in */
      let html = `
      <form onsubmit="handleLogin(event)">
        <div style="width:180px;height:auto; margin: 0 auto 30px auto;"></div>
        <h1 class="mb-3 font-weight-normal">Verify Email</h1>
        <p><small>For security purposes, we need to verify your email address.</small></p>
        <label for="inputEmail" class="sr-only">Email address</label>
        <input name="email" type="email" id="inputEmail" class="form-control mb-3" placeholder="Email address" aria-label="email address" autofocus>
        <button class="btn btn-lg btn-primary btn-block" type="submit">Confirm Email</button>
      </form>
      `;

      if (isLoggedIn) {
        /* Get user metadata including email */
        // window.document.location.href = "/my-account.html"
        const userMetadata = await magic.user.getMetadata();
        const { email } = await magic.user.getMetadata();
          //Check valid invite
          if(invite !== null){
          let validInvite = await checkInvite(invite,email);
          if (validInvite.data !== false){
            if(validInvite.data.inputEmail !== undefined){
              if(validInvite.data.inputEmail === email){
                //save new user
                await fdb.connections.put({
                  name: validInvite.data.invitedBy,
                  publicAddress: validInvite.data.senderKey,
                  friendState:"ZZZ",
                  connectionState: "active"
                })
              }
            }
            
          }
          let userData = await getUser(did);
          // if(userData !== undefined){
          //   console.log(userData)
          //   //todo: import database
          //   db = await Dexie.import(userData, {
          //     progressCallback
          //   });
          //   console.log("Import complete");
          // } else {
            //write initial data to database
            db.open()
            .then(async function(){
              return db.settings.get({email:userMetadata.email});
            })
            .then(function (user) {
              console.log(user)
              if(user)
                console.log(user)
              else{
                db.settings.put({id:1,email: email,uid:userMetadata.issuer,publicAddress:userMetadata.publicAddress})
                window.document.location.href = "/my-account.html"
              }
                
            }).catch(function(error) {
              console.log ("Ooops: " + error);
            });
          // }

          html = `
            <h1>Current user: ${userMetadata.email}</h1>
            <button><a href="/friends.html">Friends</a></button>
            <button><a href="/my-account.html">Account</a></button>
            <button onclick="handleLogout()">Logout</button>
          `;
        }
        
        //write initial data to database
        db.open()
        .then(function(){
          return db.settings.get({email:userMetadata.email});
        })
        .then(async function (user) {
          console.log(user)
          if(user)
            console.log(user)
          else{
            //write initial data to database
            let userData = await getUser(did);
            if(!isEmpty(userData)){
              //todo: import database
              await importUser(userData);
            } else{
              db.settings.add({id:1,email: email,uid:userMetadata.issuer,publicAddress:userMetadata.publicAddress})
            }
            // window.document.location.href = "/my-account.html"
          }
            
        }).catch(function(error) {
          console.log ("Ooops: " + error);
        });
        

        html = `
          <h1>Current user: ${userMetadata.email}</h1>
          <button><a href="/friends.html">Friends</a></button>
          <button><a href="/my-account.html">Account</a></button>
          <button onclick="handleLogout()">Logout</button>
        `;
      }

      document.getElementById("app").innerHTML = html;
    };
    /* 4️⃣ Implement Login Handler */
    const handleLogin = async (e) => {
      e.preventDefault();
      const email = new FormData(e.target).get("email");
      if (email) {
        /* One-liner login 🤯 */
        await magic.auth.loginWithMagicLink({ email });
        render();
      }
    };

    /* 5️⃣ Implement Logout Handler */
    const handleLogout = async () => {
      await db.delete();
      await fdb.delete();
      await invitedb.delete();
      await magic.user.logout();
      render();
    };


    let importUser = async (data) => {
      const base64 = await fetch(data);
      const blob = await base64.blob();
      await db.import(blob, [{overwriteValues:true}]);
    }

    let importFriends = async (data) => {
      const base64 = await fetch(data);
      const blob = await base64.blob();
      await fdb.import(blob, [{overwriteValues:true}]);
    }


    let getFriends = async (chanId,blob) => {
      //
      // Export to Blob
      //
      let reader = new FileReader();
      reader.readAsDataURL(blob); 
      reader.onloadend = async function() {
        let base64data = reader.result;                
        // console.log(base64data);
        const init = {
          method: 'GET',
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            'X-Custom-DID': did
          }
        };
        try {
          const fetchResponse = await fetch(`https://api.noctis-alba.com/getFriends`, init);
          const data = await fetchResponse.json();
          return data;
        } catch (e) {
          return e;
        }
        return true;
      };
    }
	</script>
</html>
